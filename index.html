<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle Financeiro</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220, #0f172a 40%);
      color: var(--text);
    }
    header {
      padding: 24px 16px; max-width: 1100px; margin: 0 auto;
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .sub { color: var(--muted); font-size: 14px; }

    .container { max-width: 1100px; margin: 0 auto; padding: 0 16px 48px; }
    .grid {
      display: grid; gap: 16px; grid-template-columns: 1fr; 
    }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .card h2 { margin: 0 0 12px; font-size: 18px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }
    input, select, button, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background:#0b1220; color: var(--text);
    }
    input[type="number"] { text-align: right; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width:640px){ .row{ grid-template-columns: repeat(6,1fr);} }
    .col-2{ grid-column: span 2; } .col-3{ grid-column: span 3; } .col-4{ grid-column: span 4; } .col-6{ grid-column: span 6; }

    .btn { cursor: pointer; border: 1px solid var(--border); transition: .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: #16a34a; border-color:#15803d; }
    .btn-muted { background: #0b1220; }
    .btn-danger { background: #991b1b; border-color:#7f1d1d; }

    .summary { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
    .stat { background:#0b1220; border:1px dashed var(--border); padding:14px; border-radius:12px; }
    .stat .label { color: var(--muted); font-size:12px; }
    .stat .value { margin-top:6px; font-size:20px; }

    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-size:12px; color: var(--muted); padding:10px; border-bottom:1px solid var(--border); }
    tbody td { padding:12px 10px; border-bottom:1px dashed var(--border); vertical-align: top; }
    .right { text-align:right; }
    .chip { padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b1220; }
    .chip.income { color:#22c55e; }
    .chip.expense { color:#f87171; }

    .actions { display:flex; gap:8px; justify-content:flex-end; }
    .actions button { width:auto; padding:8px 10px; font-size:12px; }

    footer { max-width:1100px; margin: 12px auto 40px; padding: 0 16px; color: var(--muted); font-size: 12px; }
    .inline { display:flex; gap:8px; flex-wrap: wrap; }
    .inline > * { flex: 1 1 160px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Controle Financeiro</h1>
    <div class="sub">Cadastre receitas e despesas, filtre por mês e acompanhe seu saldo. Os dados ficam salvos no seu navegador (localStorage).</div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Formulário -->
      <section class="card">
        <h2>Nova movimentação</h2>
        <form id="txForm" autocomplete="off">
          <div class="row">
            <div class="col-2">
              <label for="type">Tipo</label>
              <select id="type" required>
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
              </select>
            </div>
            <div class="col-2">
              <label for="date">Data</label>
              <input id="date" type="date" required />
            </div>
            <div class="col-2">
              <label for="amount">Valor (R$)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="0,00" required />
            </div>
            <div class="col-3">
              <label for="category">Categoria</label>
              <div class="inline">
                <select id="category" required>
                  <option>Alimentação</option>
                  <option>Moradia</option>
                  <option>Transporte</option>
                  <option>Lazer</option>
                  <option>Saúde</option>
                  <option>Salário</option>
                  <option>Serviços</option>
                  <option>Outros</option>
                </select>
                <input id="newCat" type="text" placeholder="Adicionar categoria (opcional)" />
              </div>
            </div>
            <div class="col-3">
              <label for="desc">Descrição</label>
              <input id="desc" type="text" placeholder="Ex.: Supermercado, Aluguel, Bônus" />
            </div>
            <div class="col-6">
              <button class="btn btn-primary" type="submit">Adicionar</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Filtros e Resumo -->
      <section class="card">
        <h2>Filtros & Resumo</h2>
        <div class="row">
          <div class="col-3">
            <label for="month">Mês</label>
            <input id="month" type="month" />
          </div>
          <div class="col-3">
            <label for="fCat">Categoria</label>
            <select id="fCat">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-6">
            <label for="search">Busca</label>
            <input id="search" type="text" placeholder="Filtrar por descrição" />
          </div>
        </div>
        <div class="summary" style="margin-top:12px;">
          <div class="stat">
            <div class="label">Receitas</div>
            <div id="sumIncome" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Despesas</div>
            <div id="sumExpense" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Saldo</div>
            <div id="sumBalance" class="value">R$ 0,00</div>
          </div>
        </div>
        <div style="margin-top:12px;" class="inline">
          <button id="btnExportCsv" class="btn btn-muted" type="button">Exportar CSV</button>
          <button id="btnExportJson" class="btn btn-muted" type="button">Exportar JSON</button>
          <label class="btn btn-muted" style="display:inline-flex; align-items:center; justify-content:center; cursor:pointer;">
            Importar JSON
            <input id="importFile" class="hidden" type="file" accept="application/json" />
          </label>
          <button id="btnReset" class="btn btn-danger" type="button" title="Apaga todas as movimentações">Limpar tudo</button>
        </div>
      </section>
    </div>

    <!-- Tabela -->
    <section class="card" style="margin-top:16px;">
      <h2>Movimentações</h2>
      <div style="overflow:auto;">
        <table id="txTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th class="right">Valor</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <footer>
    Feito para uso local. Nenhum dado é enviado para servidores. Dica: pressione Ctrl/Cmd + S no navegador para salvar este arquivo e reutilizar.
  </footer>

  <script>
    const storeKey = 'cf_transactions_v1';
    const $ = (s) => document.querySelector(s);

    const state = {
      transactions: [], // {id, type:'income'|'expense', date:'YYYY-MM-DD', category, desc, amountCents}
      filters: { month: '', category: '', search: '' }
    };

    // Utilidades
    const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseAmount = (v) => Math.round(Number(String(v).replace(',', '.')) * 100);
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function save(){ localStorage.setItem(storeKey, JSON.stringify(state.transactions)); }
    function load(){
      try { state.transactions = JSON.parse(localStorage.getItem(storeKey) || '[]'); }
      catch { state.transactions = []; }
    }

    function ensureMonth(){
      const m = $('#month');
      if(!m.value){
        const d = new Date();
        const ym = d.toISOString().slice(0,7);
        m.value = ym;
        state.filters.month = ym;
      }
    }

    function categories(){
      const base = new Set(['Alimentação','Moradia','Transporte','Lazer','Saúde','Salário','Serviços','Outros']);
      state.transactions.forEach(t => base.add(t.category));
      return Array.from(base).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    }

    function refreshCategoryFilters(){
      const fCat = $('#fCat');
      fCat.innerHTML = '<option value="">Todas</option>' + categories().map(c=>`<option>${c}</option>`).join('');
      // Seleciona se já havia filtro aplicado
      if(state.filters.category){ fCat.value = state.filters.category; }
      // Também atualiza o select do formulário
      const catSel = $('#category');
      catSel.innerHTML = categories().map(c=>`<option>${c}</option>`).join('');
    }

    function applyFilters(list){
      const { month, category, search } = state.filters;
      return list.filter(t => {
        const inMonth = month ? t.date.startsWith(month) : true;
        const inCat = category ? t.category === category : true;
        const inSearch = search ? (t.desc || '').toLowerCase().includes(search.toLowerCase()) : true;
        return inMonth && inCat && inSearch;
      });
    }

    function summarize(list){
      let inc = 0, exp = 0;
      list.forEach(t => { if(t.type==='income') inc += t.amountCents; else exp += t.amountCents; });
      $('#sumIncome').textContent = fmt.format(inc/100);
      $('#sumExpense').textContent = fmt.format(exp/100);
      $('#sumBalance').textContent = fmt.format((inc-exp)/100);
    }

    function render(){
      refreshCategoryFilters();
      const body = $('#txBody');
      body.innerHTML = '';
      const filtered = applyFilters(state.transactions).sort((a,b)=> b.date.localeCompare(a.date));
      for(const t of filtered){
        const tr = document.createElement('tr');
        const chipClass = t.type==='income' ? 'income' : 'expense';
        tr.innerHTML = `
          <td>${t.date.split('-').reverse().join('/')}</td>
          <td><span class="chip ${chipClass}">${t.type==='income'?'Receita':'Despesa'}</span></td>
          <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.desc || '')}</td>
          <td class="right">${fmt.format(t.amountCents/100)}</td>
          <td class="right actions">
            <button class="btn btn-muted" data-edit="${t.id}">Editar</button>
            <button class="btn btn-danger" data-del="${t.id}">Excluir</button>
          </td>
        `;
        body.appendChild(tr);
      }
      summarize(filtered);
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // CRUD
    function addTx(e){
      e.preventDefault();
      const type = $('#type').value;
      const date = $('#date').value || new Date().toISOString().slice(0,10);
      const amountCents = parseAmount($('#amount').value || 0);
      let category = $('#category').value;
      const newCat = $('#newCat').value.trim();
      if(newCat){ category = newCat; $('#newCat').value=''; }
      const desc = $('#desc').value.trim();
      if(!amountCents){ alert('Informe um valor válido.'); return; }
      const tx = { id: uid(), type, date, category, desc, amountCents };
      state.transactions.push(tx);
      save();
      (e.target).reset();
      ensureMonth();
      render();
    }

    function onTableClick(e){
      const delId = e.target.getAttribute('data-del');
      const editId = e.target.getAttribute('data-edit');
      if(delId){
        if(confirm('Excluir esta movimentação?')){
          state.transactions = state.transactions.filter(t=>t.id!==delId);
          save(); render();
        }
      }
      if(editId){
        const t = state.transactions.find(x=>x.id===editId);
        if(!t) return;
        const desc = prompt('Descrição:', t.desc||''); if(desc===null) return;
        const amountStr = prompt('Valor (R$):', (t.amountCents/100).toFixed(2).replace('.', ',')); if(amountStr===null) return;
        const category = prompt('Categoria:', t.category); if(category===null) return;
        const date = prompt('Data (AAAA-MM-DD):', t.date); if(date===null) return;
        const type = prompt('Tipo (income/expense):', t.type); if(type===null) return;
        const amountCents = parseAmount(amountStr);
        if(!amountCents || (type!=='income' && type!=='expense') || !/^\d{4}-\d{2}-\d{2}$/.test(date)){
          alert('Dados inválidos. Edição cancelada.'); return;
        }
        Object.assign(t, { desc, amountCents, category, date, type });
        save(); render();
      }
    }

    // Export / Import
    function download(filename, content, mime){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], { type: mime }));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    function toCSV(list){
      const header = ['id','tipo','data','categoria','descricao','valor'];
      const rows = list.map(t=>[
        t.id,
        t.type,
        t.date,
        '"'+String(t.category).replaceAll('"','""')+'"',
        '"'+String(t.desc||'').replaceAll('"','""')+'"',
        (t.amountCents/100).toFixed(2).replace('.', ',')
      ].join(','));
      return header.join(',')+'\n'+rows.join('\n');
    }

    // Eventos UI
    $('#txForm').addEventListener('submit', addTx);
    $('#txTable').addEventListener('click', onTableClick);

    $('#month').addEventListener('input', e=>{ state.filters.month = e.target.value; render(); });
    $('#fCat').addEventListener('change', e=>{ state.filters.category = e.target.value; render(); });
    $('#search').addEventListener('input', e=>{ state.filters.search = e.target.value; render(); });

    $('#btnExportCsv').addEventListener('click', ()=>{
      const filtered = applyFilters(state.transactions);
      download('movimentacoes.csv', toCSV(filtered), 'text/csv;charset=utf-8');
    });
    $('#btnExportJson').addEventListener('click', ()=>{
      const filtered = applyFilters(state.transactions);
      download('movimentacoes.json', JSON.stringify(filtered, null, 2), 'application/json');
    });
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Formato inválido');
        // Normaliza e mescla sem duplicar IDs
        const ids = new Set(state.transactions.map(t=>t.id));
        arr.forEach(x=>{
          if(!x || typeof x!=='object') return;
          const t = {
            id: x.id || uid(),
            type: x.type==='income'?'income':'expense',
            date: /^\d{4}-\d{2}-\d{2}$/.test(x.date?String(x.date):'') ? x.date : new Date().toISOString().slice(0,10),
            category: String(x.category||'Outros'),
            desc: String(x.desc||x.descricao||''),
            amountCents: Number.isFinite(x.amountCents) ? x.amountCents : parseAmount(x.valor||0)
          };
          if(!ids.has(t.id)){ state.transactions.push(t); ids.add(t.id); }
        });
        save(); render();
        alert('Importação concluída.');
      }catch(err){ alert('Falha ao importar: '+ err.message); }
      e.target.value = '';
    });

    $('#btnReset').addEventListener('click', ()=>{
      if(confirm('Tem certeza? Isso apagará todas as movimentações salvas.')){
        state.transactions = []; save(); render();
      }
    });

    // Inicialização
    load();
    ensureMonth();
    render();
  </script>
</body>
</html>
