<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle Financeiro</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Controle Financeiro</h1>
    <div class="sub">Cadastre receitas e despesas, filtre por mês e acompanhe seu saldo. Os dados ficam salvos no seu navegador (localStorage).</div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Formulário -->
      <section class="card">
        <h2>Nova movimentação</h2>
        <form id="txForm" autocomplete="off">
          <div class="row">
            <div class="col-2">
              <label for="type">Tipo</label>
              <select id="type" required>
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
              </select>
            </div>
            <div class="col-2">
              <label for="date">Data</label>
              <input id="date" type="date" required />
            </div>
            <div class="col-2">
              <label for="amount">Valor (R$)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="0,00" required />
            </div>
            <div class="col-3">
              <label for="category">Categoria</label>
              <div class="inline">
                <select id="category" required></select>
                <input id="newCat" type="text" placeholder="Adicionar categoria (opcional)" />
              </div>
            </div>
            <div class="col-3">
              <label for="method">Forma de pagamento</label>
              <select id="method" required>
                <option>PIX</option>
                <option>CARTÃO DE DÉBITO</option>
                <option>CARTÃO DE CRÉDITO</option>
                <option>BOLETO</option>
                <option>TED</option>
                <option>DÉBITO AUTOMÁTICO</option>
              </select>
            </div>
            <div class="col-6">
              <label for="desc">Descrição</label>
              <input id="desc" type="text" placeholder="Ex.: Supermercado, Aluguel, Bônus" />
            </div>
            <div class="col-6">
              <button class="btn btn-primary" type="submit">Adicionar</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Filtros e Resumo -->
      <section class="card">
        <h2>Filtros & Resumo</h2>
        <div class="row">
          <div class="col-2">
            <label for="month">Mês</label>
            <input id="month" type="month" />
          </div>
          <div class="col-2">
            <label for="fCat">Categoria</label>
            <select id="fCat">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-2">
            <label for="fMethod">Forma de pagamento</label>
            <select id="fMethod">
              <option value="">Todas</option>
              <option>PIX</option>
              <option>CARTÃO DE DÉBITO</option>
              <option>CARTÃO DE CRÉDITO</option>
              <option>BOLETO</option>
              <option>TED</option>
              <option>DÉBITO AUTOMÁTICO</option>
            </select>
          </div>
          <div class="col-6">
            <label for="search">Busca</label>
            <input id="search" type="text" placeholder="Filtrar por descrição" />
          </div>
        </div>
        <div class="summary" style="margin-top:12px;">
          <div class="stat">
            <div class="label">Receitas</div>
            <div id="sumIncome" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Despesas</div>
            <div id="sumExpense" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Saldo</div>
            <div id="sumBalance" class="value">R$ 0,00</div>
          </div>
        </div>
        <div style="margin-top:12px;" class="inline">
          <button id="btnExportCsv" class="btn btn-muted" type="button">Exportar CSV</button>
          <button id="btnExportJson" class="btn btn-muted" type="button">Exportar JSON</button>
          <label class="btn btn-muted" style="display:inline-flex; align-items:center; justify-content:center; cursor:pointer;">
            Importar JSON
            <input id="importFile" class="hidden" type="file" accept="application/json" />
          </label>
          <button id="btnReset" class="btn btn-danger" type="button" title="Apaga todas as movimentações">Limpar tudo</button>
        </div>
      </section>
    </div>

    <!-- Tabela -->
    <section class="card" style="margin-top:16px;">
      <h2>Movimentações</h2>
      <div class="table-wrap">
        <table id="txTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Forma</th>
              <th>Descrição</th>
              <th class="right">Valor</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <footer>
    Feito para uso local. Nenhum dado é enviado para servidores. Dica: pressione Ctrl/Cmd + S no navegador para salvar este arquivo e reutilizar.
  </footer>

  <script>
    const storeKey = 'cf_transactions_v2';
    const $ = (s) => document.querySelector(s);

    const state = {
      transactions: [], // {id, type, date, category, method, desc, amountCents}
      filters: { month: '', category: '', method: '', search: '' }
    };

    // Listas fixas
    const CATEGORY_LIST = [
      'ÁGUA','ALMOÇO','ALTOQI','ANIVERSÁRIO','ART','AUTODESK','CARRO','COMPRA TECNOLOGIA','CONSULTORIA ESPECIALIZADA','CUSTO ADM','DESPESAS','DESPESAS CARTÕES','ENERGIA','ENTRADA','FOLHA SALARIAL','GASOLINA','JANTAR','LIMPEZA','MANUTENÇÃO','TARIFA SICOOB','TERCEIRIZADO','UBER'
    ];
    const METHOD_LIST = ['PIX','CARTÃO DE DÉBITO','CARTÃO DE CRÉDITO','BOLETO','TED','DÉBITO AUTOMÁTICO'];

    // Utilidades
    const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseAmount = (v) => Math.round(Number(String(v).replace(',', '.')) * 100);
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function save(){ localStorage.setItem(storeKey, JSON.stringify(state.transactions)); }
    function load(){
      try { state.transactions = JSON.parse(localStorage.getItem(storeKey) || '[]'); }
      catch { state.transactions = []; }
    }

    function ensureMonth(){
      const m = $('#month');
      if(!m.value){
        const d = new Date();
        const ym = d.toISOString().slice(0,7);
        m.value = ym;
        state.filters.month = ym;
      }
    }

    function categories(){
      // Fixa nas fornecidas, mas permite incluir novas via campo opcional
      const base = new Set(CATEGORY_LIST);
      state.transactions.forEach(t => base.add(t.category));
      return Array.from(base).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    }

    function refreshCategoryFilters(){
      const fCat = $('#fCat');
      fCat.innerHTML = '<option value="">Todas</option>' + categories().map(c=>`<option>${c}</option>`).join('');
      if(state.filters.category){ fCat.value = state.filters.category; }
      const catSel = $('#category');
      catSel.innerHTML = categories().map(c=>`<option>${c}</option>`).join('');
    }

    function applyFilters(list){
      const { month, category, method, search } = state.filters;
      return list.filter(t => {
        const inMonth = month ? t.date.startsWith(month) : true;
        const inCat = category ? t.category === category : true;
        const inMethod = method ? t.method === method : true;
        const inSearch = search ? (t.desc || '').toLowerCase().includes(search.toLowerCase()) : true;
        return inMonth && inCat && inMethod && inSearch;
      });
    }

    function summarize(list){
      let inc = 0, exp = 0;
      list.forEach(t => { if(t.type==='income') inc += t.amountCents; else exp += t.amountCents; });
      $('#sumIncome').textContent = fmt.format(inc/100);
      $('#sumExpense').textContent = fmt.format(exp/100);
      $('#sumBalance').textContent = fmt.format((inc-exp)/100);
    }

    function render(){
      refreshCategoryFilters();
      const body = $('#txBody');
      body.innerHTML = '';
      const filtered = applyFilters(state.transactions).sort((a,b)=> b.date.localeCompare(a.date));
      for(const t of filtered){
        const tr = document.createElement('tr');
        const chipClass = t.type==='income' ? 'income' : 'expense';
        tr.innerHTML = `
          <td>${t.date.split('-').reverse().join('/')}</td>
          <td><span class="chip ${chipClass}">${t.type==='income'?'Receita':'Despesa'}</span></td>
          <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.method || '')}</td>
          <td>${escapeHtml(t.desc || '')}</td>
          <td class="right">${fmt.format(t.amountCents/100)}</td>
          <td class="right actions">
            <button class="btn btn-muted" data-edit="${t.id}">Editar</button>
            <button class="btn btn-danger" data-del="${t.id}">Excluir</button>
          </td>
        `;
        body.appendChild(tr);
      }
      summarize(filtered);
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // CRUD
    function addTx(e){
      e.preventDefault();
      const type = $('#type').value;
      const date = $('#date').value || new Date().toISOString().slice(0,10);
      const amountCents = parseAmount($('#amount').value || 0);
      let category = $('#category').value;
      const newCat = $('#newCat').value.trim();
      if(newCat){ category = newCat; $('#newCat').value=''; }
      const method = $('#method').value;
      const desc = $('#desc').value.trim();
      if(!amountCents){ alert('Informe um valor válido.'); return; }
      const tx = { id: uid(), type, date, category, method, desc, amountCents };
      state.transactions.push(tx);
      save();
      (e.target).reset();
      ensureMonth();
      render();
    }

    function onTableClick(e){
      const delId = e.target.getAttribute('data-del');
      const editId = e.target.getAttribute('data-edit');
      if(delId){
        if(confirm('Excluir esta movimentação?')){
          state.transactions = state.transactions.filter(t=>t.id!==delId);
          save(); render();
        }
      }
      if(editId){
        const t = state.transactions.find(x=>x.id===editId);
        if(!t) return;
        const desc = prompt('Descrição:', t.desc||''); if(desc===null) return;
        const amountStr = prompt('Valor (R$):', (t.amountCents/100).toFixed(2).replace('.', ',')); if(amountStr===null) return;
        const category = prompt('Categoria:', t.category); if(category===null) return;
        const method = prompt('Forma de pagamento:', t.method||'PIX'); if(method===null) return;
        const date = prompt('Data (AAAA-MM-DD):', t.date); if(date===null) return;
        const type = prompt('Tipo (income/expense):', t.type); if(type===null) return;
        const amountCents = parseAmount(amountStr);
        if(!amountCents || (type!=='income' && type!=='expense') || !/^\d{4}-\d{2}-\d{2}$/.test(date)){
          alert('Dados inválidos. Edição cancelada.'); return;
        }
        Object.assign(t, { desc, amountCents, category, method, date, type });
        save(); render();
      }
    }

    // Export / Import
    function download(filename, content, mime){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], { type: mime }));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    function toCSV(list){
      const header = ['id','tipo','data','categoria','forma_pagamento','descricao','valor'];
      const rows = list.map(t=>[
        t.id,
        t.type,
        t.date,
        '"'+String(t.category).replaceAll('"','""')+'"',
        '"'+String(t.method||'').replaceAll('"','""')+'"',
        '"'+String(t.desc||'').replaceAll('"','""')+'"',
        (t.amountCents/100).toFixed(2).replace('.', ',')
      ].join(','));
      return header.join(',')+'\n'+rows.join('\n');
    }

    // Eventos UI
    $('#txForm').addEventListener('submit', addTx);
    $('#txTable').addEventListener('click', onTableClick);

    $('#month').addEventListener('input', e=>{ state.filters.month = e.target.value; render(); });
    $('#fCat').addEventListener('change', e=>{ state.filters.category = e.target.value; render(); });
    $('#fMethod').addEventListener('change', e=>{ state.filters.method = e.target.value; render(); });
    $('#search').addEventListener('input', e=>{ state.filters.search = e.target.value; render(); });

    $('#btnExportCsv').addEventListener('click', ()=>{
      const filtered = applyFilters(state.transactions);
      download('movimentacoes.csv', toCSV(filtered), 'text/csv;charset=utf-8');
    });
    $('#btnExportJson').addEventListener('click', ()=>{
      const filtered = applyFilters(state.transactions);
      download('movimentacoes.json', JSON.stringify(filtered, null, 2), 'application/json');
    });
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Formato inválido');
        const ids = new Set(state.transactions.map(t=>t.id));
        arr.forEach(x=>{
          if(!x || typeof x!=='object') return;
          const t = {
            id: x.id || uid(),
            type: x.type==='income'?'income':'expense',
            date: /^\d{4}-\d{2}-\d{2}$/.test(x.date?String(x.date):'') ? x.date : new Date().toISOString().slice(0,10),
            category: String(x.category||x.categoria||'Outros'),
            method: String(x.method||x.forma_pagamento||'PIX'),
            desc: String(x.desc||x.descricao||''),
            amountCents: Number.isFinite(x.amountCents) ? x.amountCents : parseAmount(x.valor||0)
          };
          if(!ids.has(t.id)){ state.transactions.push(t); ids.add(t.id); }
        });
        save(); render();
        alert('Importação concluída.');
      }catch(err){ alert('Falha ao importar: '+ err.message); }
      e.target.value = '';
    });

    $('#btnReset').addEventListener('click', ()=>{
      if(confirm('Tem certeza? Isso apagará todas as movimentações salvas.')){
        state.transactions = []; save(); render();
      }
    });

    // Inicialização
    load();
    ensureMonth();
    // Preenche selects iniciais
    (function initCategorySelect(){
      const catSel = $('#category');
      catSel.innerHTML = categories().map(c=>`<option>${c}</option>`).join('');
    })();
    render();
  </script>
</body>
</html>
