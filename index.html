<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle Financeiro</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Evita 404 do favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='100%25' height='100%25' rx='6' ry='6' fill='%230f172a'/%3E%3Ctext x='50%25' y='62%25' dominant-baseline='middle' text-anchor='middle' fill='%23e5e7eb' font-size='18' font-family='Arial,Helvetica,sans-serif'%3EFR%3C/text%3E%3C/svg%3E" />
  <style>
    /* Pequenos estilos extras para gráficos */
    .charts { display:grid; gap:16px; grid-template-columns: 1fr; margin-top:16px; }
    @media (min-width: 900px){ .charts { grid-template-columns: 1fr 1fr; } }
    canvas { width: 100%; height: 340px; border: 1px dashed var(--border); border-radius: 12px; background: #0b1220; }
    .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .legend .item { display:inline-flex; align-items:center; gap:6px; font-size:12px; color: var(--muted); padding:6px 8px; border:1px solid var(--border); border-radius: 999px; }
    .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
  </style>
</head>
<body>
  <header>
    <h1>Controle Financeiro</h1>
    <div class="sub">Cadastre receitas e despesas, filtre por <b>ano e mês</b>, veja os maiores gastos em gráficos e exporte CSV. Tudo salvo localmente (localStorage).</div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Formulário -->
      <section class="card">
        <h2>Nova movimentação</h2>
        <form id="txForm" autocomplete="off">
          <div class="row">
            <div class="col-2">
              <label for="type">Tipo</label>
              <select id="type" required>
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
              </select>
            </div>
            <div class="col-2">
              <label for="date">Data</label>
              <input id="date" type="date" required />
            </div>
            <div class="col-2">
              <label for="amount">Valor (R$)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="0,00" required />
            </div>
            <div class="col-3">
              <label for="category">Categoria</label>
              <select id="category" required></select>
            </div>
            <div class="col-3">
              <label for="method">Forma de pagamento</label>
              <select id="method" required>
                <option>PIX</option>
                <option>CARTÃO DE DÉBITO</option>
                <option>CARTÃO DE CRÉDITO</option>
                <option>BOLETO</option>
                <option>TED</option>
                <option>DÉBITO AUTOMÁTICO</option>
              </select>
            </div>
            <div class="col-6">
              <label for="desc">Descrição</label>
              <input id="desc" type="text" placeholder="Ex.: Energia, Aluguel, Uber" />
            </div>
            <div class="col-6">
              <button class="btn btn-primary" type="submit">Adicionar</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Filtros e Resumo -->
      <section class="card">
        <h2>Filtros & Resumo</h2>
        <div class="row">
          <div class="col-2">
            <label for="year">Ano</label>
            <select id="year"></select>
          </div>
          <div class="col-2">
            <label for="month">Mês</label>
            <select id="month">
              <option value="">Todos</option>
              <option value="01">Jan</option>
              <option value="02">Fev</option>
              <option value="03">Mar</option>
              <option value="04">Abr</option>
              <option value="05">Mai</option>
              <option value="06">Jun</option>
              <option value="07">Jul</option>
              <option value="08">Ago</option>
              <option value="09">Set</option>
              <option value="10">Out</option>
              <option value="11">Nov</option>
              <option value="12">Dez</option>
            </select>
          </div>
          <div class="col-2">
            <label for="fCat">Categoria</label>
            <select id="fCat">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-2">
            <label for="fMethod">Forma</label>
            <select id="fMethod">
              <option value="">Todas</option>
              <option>PIX</option>
              <option>CARTÃO DE DÉBITO</option>
              <option>CARTÃO DE CRÉDITO</option>
              <option>BOLETO</option>
              <option>TED</option>
              <option>DÉBITO AUTOMÁTICO</option>
            </select>
          </div>
          <div class="col-2">
            <label for="search">Busca</label>
            <input id="search" type="text" placeholder="Filtrar por descrição" />
          </div>
          <div class="col-2">
            <label>&nbsp;</label>
            <button id="btnExportCsv" class="btn btn-muted" type="button">Exportar CSV</button>
          </div>
        </div>
        <div class="summary" style="margin-top:12px;">
          <div class="stat">
            <div class="label">Receitas</div>
            <div id="sumIncome" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Despesas</div>
            <div id="sumExpense" class="value">R$ 0,00</div>
          </div>
          <div class="stat">
            <div class="label">Saldo</div>
            <div id="sumBalance" class="value">R$ 0,00</div>
          </div>
        </div>
      </section>
    </div>

    <!-- Tabela -->
    <section class="card" style="margin-top:16px;">
      <h2>Movimentações</h2>
      <div class="table-wrap">
        <table id="txTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Forma</th>
              <th>Descrição</th>
              <th class="right">Valor</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="card" style="margin-top:16px;">
      <h2>Maiores gastos (gráficos)</h2>
      <div class="charts">
        <div>
          <canvas id="pieCanvas" width="600" height="340"></canvas>
          <div id="pieLegend" class="legend"></div>
        </div>
        <div>
          <canvas id="barCanvas" width="600" height="340"></canvas>
          <div id="barLegend" class="legend"></div>
        </div>
      </div>
    </section>
  </div>

  <footer>
    Feito para uso local. Nenhum dado é enviado para servidores. Dica: pressione Ctrl/Cmd + S no navegador para salvar este arquivo e reutilizar.
  </footer>

  <script>
    const storeKey = 'cf_transactions_v3';
    const $ = (s) => document.querySelector(s);

    const CATEGORY_LIST = [
      'ÁGUA','ALMOÇO','ALTOQI','ANIVERSÁRIO','ART','AUTODESK','CARRO','COMPRA TECNOLOGIA','CONSULTORIA ESPECIALIZADA','CUSTO ADM','DESPESAS','DESPESAS CARTÕES','ENERGIA','ENTRADA','FOLHA SALARIAL','GASOLINA','JANTAR','LIMPEZA','MANUTENÇÃO','TARIFA SICOOB','TERCEIRIZADO','UBER'
    ];

    const state = {
      transactions: [], // {id,type,date,category,method,desc,amountCents}
      filters: { year: '', month: '', category: '', method: '', search: '' }
    };

    // Utils
    const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseAmount = (v) => Math.round(Number(String(v).replace(',', '.')) * 100);
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function save(){ localStorage.setItem(storeKey, JSON.stringify(state.transactions)); }
    function load(){
      try { state.transactions = JSON.parse(localStorage.getItem(storeKey) || '[]'); }
      catch { state.transactions = []; }
    }

    function initCategorySelects(){
      const catSel = $('#category');
      catSel.innerHTML = CATEGORY_LIST.map(c=>`<option>${c}</option>`).join('');
      const fCat = $('#fCat');
      fCat.innerHTML = '<option value="">Todas</option>' + CATEGORY_LIST.map(c=>`<option>${c}</option>`).join('');
    }

    function initYear(){
      const y = $('#year');
      const years = new Set();
      const nowY = new Date().getFullYear();
      years.add(nowY);
      state.transactions.forEach(t=> years.add(Number(t.date.slice(0,4))));
      const list = Array.from(years).sort((a,b)=>b-a);
      y.innerHTML = list.map(v=>`<option value="${v}">${v}</option>`).join('');
      state.filters.year = String(list[0] || nowY);
      y.value = state.filters.year;
    }

    function applyFilters(list){
      const { year, month, category, method, search } = state.filters;
      return list.filter(t=>{
        const [y,m] = t.date.split('-');
        const byYear = year ? y === String(year) : true;
        const byMonth = month ? m === month : true;
        const byCat = category ? t.category === category : true;
        const byMethod = method ? t.method === method : true;
        const bySearch = search ? (t.desc||'').toLowerCase().includes(search.toLowerCase()) : true;
        return byYear && byMonth && byCat && byMethod && bySearch;
      });
    }

    function summarize(list){
      let inc = 0, exp = 0;
      list.forEach(t => { if(t.type==='income') inc += t.amountCents; else exp += t.amountCents; });
      $('#sumIncome').textContent = fmt.format(inc/100);
      $('#sumExpense').textContent = fmt.format(exp/100);
      $('#sumBalance').textContent = fmt.format((inc-exp)/100);
    }

    function renderTable(){
      const body = $('#txBody');
      body.innerHTML = '';
      const filtered = applyFilters(state.transactions).sort((a,b)=> b.date.localeCompare(a.date));
      for(const t of filtered){
        const tr = document.createElement('tr');
        const chipClass = t.type==='income' ? 'income' : 'expense';
        tr.innerHTML = `
          <td>${t.date.split('-').reverse().join('/')}</td>
          <td><span class="chip ${chipClass}">${t.type==='income'?'Receita':'Despesa'}</span></td>
          <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.method||'')}</td>
          <td>${escapeHtml(t.desc||'')}</td>
          <td class="right">${fmt.format(t.amountCents/100)}</td>
          <td class="right actions">
            <button class="btn btn-muted" data-edit="${t.id}">Editar</button>
            <button class="btn btn-danger" data-del="${t.id}">Excluir</button>
          </td>`;
        body.appendChild(tr);
      }
      summarize(filtered);
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // CRUD
    function addTx(e){
      e.preventDefault();
      const type = $('#type').value;
      const date = $('#date').value || new Date().toISOString().slice(0,10);
      const amountCents = parseAmount($('#amount').value || 0);
      const category = $('#category').value;
      const method = $('#method').value;
      const desc = $('#desc').value.trim();
      if(!amountCents){ alert('Informe um valor válido.'); return; }
      const tx = { id: uid(), type, date, category, method, desc, amountCents };
      state.transactions.push(tx);
      save();
      e.target.reset();
      renderAll();
    }

    function onTableClick(e){
      const delId = e.target.getAttribute('data-del');
      const editId = e.target.getAttribute('data-edit');
      if(delId){
        if(confirm('Excluir esta movimentação?')){
          state.transactions = state.transactions.filter(t=>t.id!==delId);
          save(); renderAll();
        }
      }
      if(editId){
        const t = state.transactions.find(x=>x.id===editId);
        if(!t) return;
        const desc = prompt('Descrição:', t.desc||''); if(desc===null) return;
        const amountStr = prompt('Valor (R$):', (t.amountCents/100).toFixed(2).replace('.', ',')); if(amountStr===null) return;
        const category = prompt('Categoria:', t.category); if(category===null) return;
        const method = prompt('Forma de pagamento:', t.method||'PIX'); if(method===null) return;
        const date = prompt('Data (AAAA-MM-DD):', t.date); if(date===null) return;
        const type = prompt('Tipo (income/expense):', t.type); if(type===null) return;
        const amountCents = parseAmount(amountStr);
        if(!amountCents || (type!=='income' && type!=='expense') || !/^\d{4}-\d{2}-\d{2}$/.test(date)){
          alert('Dados inválidos. Edição cancelada.'); return;
        }
        Object.assign(t, { desc, amountCents, category, method, date, type });
        save(); renderAll();
      }
    }

    // CSV
    function download(filename, content, mime){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], { type: mime }));
      a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }
    function toCSV(list){
      const header = ['id','tipo','data','categoria','forma','descricao','valor'];
      const rows = list.map(t=>[
        t.id,
        t.type,
        t.date,
        '"'+String(t.category).replaceAll('"','""')+'"',
        '"'+String(t.method||'').replaceAll('"','""')+'"',
        '"'+String(t.desc||'').replaceAll('"','""')+'"',
        (t.amountCents/100).toFixed(2).replace('.', ',')
      ].join(','));
      return header.join(',')+'\n'+rows.join('\n');
    }

    // Gráficos
    function hsl(i,n){ return `hsl(${Math.round(360*i/n)}, 70%, 55%)`; }

    function topExpensesAgg(list, topN=5){
      const map = new Map();
      list.filter(t=>t.type==='expense').forEach(t=>{
        map.set(t.category, (map.get(t.category)||0) + t.amountCents);
      });
      const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
      const top = arr.slice(0, topN);
      const othersSum = arr.slice(topN).reduce((s, [,v])=>s+v, 0);
      if(othersSum>0) top.push(['Outros', othersSum]);
      return top.map(([k,v])=>({label:k, value:v/100}));
    }

    function drawPie(canvas, data){
      const ctx = canvas.getContext('2d');
      const { width, height } = canvas;
      ctx.clearRect(0,0,width,height);
      const cx = width/2, cy = height/2; const r = Math.min(width,height)*0.32;
      const total = data.reduce((s,d)=>s+d.value,0) || 1;
      let start = -Math.PI/2;
      data.forEach((d,i)=>{
        const ang = (d.value/total)*Math.PI*2;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,start+ang);
        ctx.closePath(); ctx.fillStyle = hsl(i,data.length);
        ctx.fill();
        start += ang;
      });
    }

    function drawBars(canvas, data){
      const ctx = canvas.getContext('2d');
      const { width, height } = canvas;
      ctx.clearRect(0,0,width,height);
      const pad = 30; const base = height - pad; const left = 60; const right = width - pad;
      const w = right - left; const max = Math.max(...data.map(d=>d.value), 1);
      const gap = 12; const bw = (w - gap*(data.length-1)) / data.length;
      // eixo
      ctx.strokeStyle = '#1f2937'; ctx.beginPath(); ctx.moveTo(left, base); ctx.lineTo(right, base); ctx.stroke();
      data.forEach((d,i)=>{
        const h = (d.value/max) * (height - pad*2);
        const x = left + i*(bw+gap);
        const y = base - h;
        ctx.fillStyle = hsl(i,data.length);
        ctx.fillRect(x, y, bw, h);
        ctx.fillStyle = '#94a3b8';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.textAlign = 'center';
        ctx.fillText(d.label.length>10? d.label.slice(0,10)+'…' : d.label, x + bw/2, base + 14);
        ctx.textAlign = 'right';
        ctx.fillText(fmt.format(d.value), x + bw, y - 4);
      });
    }

    function renderLegends(pieData){
      const pieL = $('#pieLegend');
      const barL = $('#barLegend');
      const items = pieData.map((d,i)=>`<span class="item"><i class="swatch" style="background:${hsl(i,pieData.length)}"></i>${d.label}: <b>${fmt.format(d.value)}</b></span>`).join('');
      pieL.innerHTML = items;
      barL.innerHTML = items;
    }

    function renderCharts(){
      const filtered = applyFilters(state.transactions);
      const data = topExpensesAgg(filtered, 5);
      drawPie($('#pieCanvas'), data);
      drawBars($('#barCanvas'), data);
      renderLegends(data);
    }

    // Eventos UI
    $('#txForm').addEventListener('submit', addTx);
    $('#txTable').addEventListener('click', onTableClick);
    $('#btnExportCsv').addEventListener('click', ()=>{
      const filtered = applyFilters(state.transactions);
      download('movimentacoes.csv', toCSV(filtered), 'text/csv;charset=utf-8');
    });

    $('#year').addEventListener('change', e=>{ state.filters.year = e.target.value; renderAll(); });
    $('#month').addEventListener('change', e=>{ state.filters.month = e.target.value; renderAll(); });
    $('#fCat').addEventListener('change', e=>{ state.filters.category = e.target.value; renderAll(); });
    $('#fMethod').addEventListener('change', e=>{ state.filters.method = e.target.value; renderAll(); });
    $('#search').addEventListener('input', e=>{ state.filters.search = e.target.value; renderAll(); });

    function renderAll(){
      initYear();
      renderTable();
      renderCharts();
    }

    // Inicialização
    load();
    initCategorySelects();
    initYear();
    renderAll();
  </script>
</body>
</html>
